/*
 *  Add new txt file and add  the string <num> -> testing 1, 2, 3. 100 times
 *  than read the file and put on serial output.
 *  library Adafruit_SPIFlash and SdFat - AdafruitFork
 *
 *  by Mischianti Renzo <https://mischianti.org>
 *
 *  https://mischianti.org/
 *
 *  SPIFlash connected via SPI standard check wiring on the article
 *
 */
 
#include "SdFat.h"
#include "Adafruit_SPIFlash.h"
 
Adafruit_FlashTransport_SPI flashTransport(SS, SPI); // Set CS and SPI interface
Adafruit_SPIFlash flash(&flashTransport);
 
// file system object from SdFat
FatFileSystem fatfs;
File myFile;
 
void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(100);   // wait for native usb
 
//  // Settings for the Winbond W25Q80BV (1 MiB SPI flash.)
//  // https://pdf1.alldatasheet.com/datasheet-pdf/view/555565/WINBOND/W25Q80BV.html
//  #define W25X80BV                                                            \
//    {                                                                            \
//      .total_size = (1UL << 20), /* 1 MiB */                                     \
//          .start_up_time_us = 5000, .manufacturer_id = 0xef,                     \
//      .memory_type = 0x40, .capacity = 0x14, .max_clock_speed_mhz = 104,         \
//      .quad_enable_bit_mask = 0x02, .has_sector_protection = false,              \
//      .supports_fast_read = true, .supports_qspi = true,                         \
//      .supports_qspi_writes = true, .write_status_register_split = false,        \
//      .single_status_byte = false, .is_fram = false,                             \
//    }
//
//
//  /// List of all possible flash devices used by Adafruit boards
//  static const SPIFlash_Device_t possible_devices[] = {
//      // Main devices used in current Adafruit products
//        W25X80BV,
//  };

#define W25Q128BV                                                            \
  {                                                                            \
    .total_size = (16UL << 20), /* 1 MiB */                                     \
        .start_up_time_us = 5000, .manufacturer_id = 0xef,                     \
    .memory_type = 0x40, .capacity = 0x18, .max_clock_speed_mhz = 104,         \
    .quad_enable_bit_mask = 0x02, .has_sector_protection = false,              \
    .supports_fast_read = true, .supports_qspi = true,                         \
    .supports_qspi_writes = true, .write_status_register_split = false,        \
    .single_status_byte = false, .is_fram = false,                             \
  }
 
 
static const SPIFlash_Device_t possible_devices[] = {
        W25Q128BV,
};
 
if (flash.begin(possible_devices)) {
 // if (flash.begin()) {
      Serial.println(F("Device finded and supported!"));
  } else {
      Serial.println(F("Problem to discover and configure device, check wiring also!"));
  }
  // Set 24Mhz SPI speed
  flashTransport.setClockSpeed(24000000, 24000000); // added to prevent speed problem
 
  pinMode(LED_BUILTIN, OUTPUT);
  flash.setIndicator(LED_BUILTIN, true);
 
  Serial.println("Adafruit Serial Flash read write example");
  Serial.print("JEDEC ID: "); Serial.println(flash.getJEDECID(), HEX);
  Serial.print("Flash size: "); Serial.println(flash.size());
  Serial.flush();
 
  Serial.println();
  // First call begin to mount the filesystem.  Check that it returns true
  // to make sure the filesystem was mounted.
  if (!fatfs.begin(&flash)) {
    Serial.println("Error, failed to mount newly formatted filesystem!");
    Serial.println("Was the flash chip formatted with the SdFat_format example?");
    while(1) yield();
  }
  Serial.println("Mounted filesystem!");
  Serial.println();
 
  // open the file. note that only one file can be open at a time,
  // so you have to close this one before opening another.
  myFile = fatfs.open("test1.txt", FILE_WRITE);
 
  // if the file opened okay, write to it:
  if (myFile) {
    Serial.print("Writing to test1.txt...");
    for (int i=0;i<10;i++){
     //   myFile.print(i);
        String body = "{\"value\":60,\"battInd\":1, \"valueStr\":[87,87,87,87,87,86,86,86,87,86,86,86,87,87,87,87,88,88,89,89,90,91,91,91,91,91,90,91,91,90,91,90,90,89,90,89,90,89,89,89,88,89,89,89,89,88,87,88,87,88,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,87,87,87,85,85,86,89,92,96,101,105,107,105,94,84,81,79,78,78,78,76,75,74,73,73,73,74,88,88,88,87,87,87,88,88,88,87,87,87,87,87,86,87,86,87,87,87,87,87,87,87,86,87,87,87,87,87,87,88,88,89,89,90,91,91,91,91,91,91,91,90,90,90,90,90,89,90,90,90,90,90,89,90,89,89,89,89,89,89,88,88,87,88,89,88,88,88,88,88,87,87,87,87,88,87,87,87,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,86,89,92,97,102,105,107,104,94,85,81,81,79,78,77,77,75,74,74,74,74,75,78,83,87,87,87,88,88,88,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,88,89,90,90,90,92,92,92,92,92,92,91,91,91,91,91,90,90,90,90,91,90,90,90,90,90,89,89,89,89,89,88,87,87,88,88,88,88,87,87,86,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,87,87,87,88,86,86,88,92,96,101,105,106,106,99,88,82,80,79,79,78,77,76,74,74,73,73,73,77,87,87,87,87,87,88,88,88,87,88,88,88,88,87,87,87,87,88,88,87,87,87,87,87,87,87,87,87,87,88,89,89,90,91,91,91,91,91,92,92,92,91,91,91,90,90,90,90,89,89,90,90,90,90,89,90,90,89,89,89,89,88,89,88,88,87,88,88,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,87,87,87,87,87,87,87,87,87,91,94,99,104,106,106,101,90,83,81,82,79,78,77,76,75,73,72,73,73,75,80,84,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,86,86,87,87,87,88,89,89,90,91,91,92,91,92,91,91,90,91,91,91,90,90,89,89,89,90,90,90,90,89,90,90,89,88,88,88,88,88,88,88,87,87,88,88,88,87,87,87,88,88,88,88,87,87,87,88,87,87,88,88,88,87,88,88,88,88,88,88,88,87,87,88,86,87,89,93,97,101,105,106,104,96,85,82,81,79,79,78,77,76,75,74,73,73,74,77,88,87,87,87,87,87,88,88,87,88,88,88,88,87,87,88,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,89,90,91,91,91,91,92,91,90,91,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,89,89,87,88,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,88,88,88,88,88,87,88,88,87,87,88,88,88,88,88,87,87,89,93,98,102,104,107,105,96,86,82,81,80,79,80,78,78,76,75,75,74,74,76,88,88,87,87,88,87,87,88,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,90,91,91,91,91,92,91,91,91,92,90,90,90,90,89,89,90,90,90,89,89,89,89,88,88,88,88,87,88,88,88,87,87,88,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,87,87,87,87,87,86,87,87,87,86,87,86,87,86,85,87,89,92,96,100,103,105,103,95,83,82,82,80,80,79,79,79,77,77,77,76,83,86,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,86,86,86,86,86,87,86,87,87,88,89,89,89,90,91,91,91,92,91,91,91,90,90,90,90,89,89,89,90,90,89,89,89,89,89,89,89,89,89,88,87,88,88,88,88,88,88,87,87,88,88,88,88,88,87,88,88,88,88,88,87,87,87,87,88,87,87,87,88,87,87,88,88,88,88,88,86,86,86,90,94,98,102,105,107,104,93,84,82,80,79,79,78,77,77,75,75,74,74,75,88,88,88,88,87,88,88,87,88,88,88,88,88,87,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,89,90,91,92,91,92,92,92,92,92,92,91,90,90,91,90,90,89,90,89,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,88,88,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,85,86,89,92,97,101,105,107,105,95,84,82,80,79,78,77,77,75,74,74,73,73,74,79,87,87,87,88,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,86,87,86,87,87,87,87,88,88,89,89,90,91,92,92,92,91,91,91,91,91,91,91,90,90,90,89,89,90,90,90,89,89,89,89,89,89,88,88,88,88,87,87,88,87,87,87,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,86,87,87,87,87,87,87,90,94,99,103,106,107,102,91,83,81,82,78,78,78,76,75,73,73,73,73,75,80,84,87,87,88,87,87,88,87,88,87,87,88,88,87,87,87,87,87,87,87,87,87,86,86,87,87,86,86,87,87,88,89,89,90,90,91,92,92,91,91,91,91,90,91,91,90,90,90,90,89,90,90,90,90,90,90,90,90,89,89,89,88,88,88,88,89,88,87,88,88,88,88,88,88,88,88,88,87,87,87,88,88,88,88,87,87,87,87,88,87,88,88,88,88,88,88,88,87,85,86,88,92,96,101,105,108,108,103,91,83,81,80,79,80,78,77,75,74,74,74,74,87,88,88,87,87,87,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,86,86,87,86,86,86,86,86,87,86,87,88,88,89,89,91,91,91,91,91,91,91,91,90,91,91,90,90,89,90,89,89,89,89,89,89,89,89,89,89,89,88,88,88,88,87,88,87,87,88,88,87,87,87,87,87,87,88,87,87,87,88,87,88,87,87,87,86,87,87,87,87,87,88,88,87,88,87,86,85,86,90,94,98,102,106,106,102,92,84,81,80,78,78,78,77,75,74,73,73,73,74,87,87,88,87,87,87,87,88,88,88,88,88,88,87,87,88,87,87,87,87,87,86,87,86,86,86,87,87,87,87,87,88,89,89,90,90,91,91,91,92,91,91,91,90,90,90,90,90,89,89,89,91,90,90,90,89,89,89,89,89,88,88,88,88,88,88,88,88,87,87,88,88,88,87,88,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,86,87,86,87,87,87,89,93,98,101,104,105,81,82,83,83,81,80,80,79,78,78,77,76,76,80,84,87,88,87,87,87,87,87,88,88,88,87,87,88,88,87,87,88,87,87,87,87,87,87,87,86,87,86,87,87,88,88,88,89,89,89,91,92,91,91,92,92,91,91,91,91,91,91,90,89,90,89,89,90,90,89,90,90,89,90,90,89,88,88,88,88,87,88,87,88,87,88,88,88,88,88,88,88,88,88,88,87,88,87,87,88,88,88,88,87,87,87,87,88,87,87,87,87,87,86,86,87,88,91,94,98,102,104,105,81,83,83,83,81,81,81,80,80,79,78,77,78,82,85,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,87,87,87,86,87,86,86,86,86,86,86,86,86,87,87,87,88,90,90,90,91,91,91,90,91,91,91,91,90,89,90,89,89,90,89,89,89,89,89,89,89,88,87,88,88,87,87,87,87,87,87,87,87,88,87,88,87,88,87,87,87,87,87,88,87,87,87,87,88,87,87,87,87,88,87,87,87,88,87,87,87,86,86,86,89,92,96,100,104,86,81,82,83,83,81,79,79,78,77,76,75,74,76,81,84,86,87,87,87,88,87,87,88,88,88,87,88,87,88,87,88,88,88,87,87,87,87,87,87,87,86,86,87,86,87,87,88,88,89,89,92,91,91,92,91,92,91,91,91,91,91,90,90,90,90,90,90,90,89,89,89,89,89,89,88,88,87,88,87,88,88,88,88,87,88,88,87,88,88,88,88,87,88,88,88,87,88,88,87,87,87,87,87,87,87,87,87,87,88,87,86,85,85,86,89,93,97,102,105,106,104,94,83,81,80,79,78,78,76,76,74,74,73,73,87,87,88,88,88,88,88,88,88,88,88,88,88,87,87,88,87,87,87,87,87,87,88,87,87,86,86,87,86,87,87,88,88,88,89,90,91,92,91,91,91,91,90,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,87,86,86,86,87,87,87,87,88,88,89,89,90,91,91,91,91,91,90,91,91,90,91,90,90,89,90,89,90,89,89,89,88,89,89,89,89,88,87,88,87,88,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,87,87,87,85,85,86,89,92,96,101,105,107,105,94,84,81,79,78,78,78,76,75,74,73,73,73,74,88,88,88,87,87,87,88,88,88,87,87,87,87,87,86,87,86,87,87,87,87,87,87,87,86,87,87,87,87,87,87,88,88,89,89,90,91,91,91,91,91,91,91,90,90,90,90,90,89,90,90,90,90,90,89,90,89,89,89,89,89,89,88,88,87,88,89,88,88,88,88,88,87,87,87,87,88,87,87,87,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,86,89,92,97,102,105,107,104,94,85,81,81,79,78,77,77,75,74,74,74,74,75,78,83,87,87,87,88,88,88,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,88,89,90,90,90,92,92,92,92,92,92,91,91,91,91,91,90,90,90,90,91,90,90,90,90,90,89,89,89,89,89,88,87,87,88,88,88,88,87,87,86,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,87,87,87,88,86,86,88,92,96,101,105,106,106,99,88,82,80,79,79,78,77,76,74,74,73,73,73,77,87,87,87,87,87,88,88,88,87,88,88,88,88,87,87,87,87,88,88,87,87,87,87,87,87,87,87,87,87,88,89,89,90,91,91,91,91,91,92,92,92,91,91,91,90,90,90,90,89,89,90,90,90,90,89,90,90,89,89,89,89,88,89,88,88,87,88,88,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,87,87,87,87,87,87,87,87,87,91,94,99,104,106,106,101,90,83,81,82,79,78,77,76,75,73,72,73,73,75,80,84,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,86,86,87,87,87,88,89,89,90,91,91,92,91,92,91,91,90,91,91,91,90,90,89,89,89,90,90,90,90,89,90,90,89,88,88,88,88,88,88,88,87,87,88,88,88,87,87,87,88,88,88,88,87,87,87,88,87,87,88,88,88,87,88,88,88,88,88,88,88,87,87,88,86,87,89,93,97,101,105,106,104,96,85,82,81,79,79,78,77,76,75,74,73,73,74,77,88,87,87,87,87,87,88,88,87,88,88,88,88,87,87,88,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,89,90,91,91,91,91,92,91,90,91,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,89,89,87,88,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,88,88,88,88,88,87,88,88,87,87,88,88,88,88,88,87,87,89,93,98,102,104,107,105,96,86,82,81,80,79,80,78,78,76,75,75,74,74,76,88,88,87,87,88,87,87,88,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,90,91,91,91,91,92,91,91,91,92,90,90,90,90,89,89,90,90,90,89,89,89,89,88,88,88,88,87,88,88,88,87,87,88,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,87,87,87,87,87,86,87,87,87,86,87,86,87,86,85,87,89,92,96,100,103,105,103,95,83,82,82,80,80,79,79,79,77,77,77,76,83,86,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,86,86,86,86,86,87,86,87,87,88,89,89,89,90,91,91,91,92,91,91,91,90,90,90,90,89,89,89,90,90,89,89,89,89,89,89,89,89,89,88,87,88,88,88,88,88,88,87,87,88,88,88,88,88,87,88,88,88,88,88,87,87,87,87,88,87,87,87,88,87,87,88,88,88,88,88,86,86,86,90,94,98,102,105,107,104,93,84,82,80,79,79,78,77,77,75,75,74,74,75,88,88,88,88,87,88,88,87,88,88,88,88,88,87,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,89,90,91,92,91,92,92,92,92,92,92,91,90,90,91,90,90,89,90,89,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,88,88,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,85,86,89,92,97,101,105,107,105,95,84,82,80,79,78,77,77,75,74,74,73,73,74,79,87,87,87,88,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,86,87,86,87,87,87,87,88,88,89,89,90,91,92,92,92,91,91,91,91,91,91,91,90,90,90,89,89,90,90,90,89,89,89,89,89,89,88,88,88,88,87,87,88,87,87,87,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,86,87,87,87,87,87,87,90,94,99,103,106,107,102,91,83,81,82,78,78,78,76,75,73,73,73,73,75,80,84,87,87,88,87,87,88,87,88,87,87,88,88,87,87,87,87,87,87,87,87,87,86,86,87,87,86,86,87,87,88,89,89,90,90,91,92,92,91,91,91,91,90,91,91,90,90,90,90,89,90,90,90,90,90,90,90,90,89,89,89,88,88,88,88,89,88,87,88,88,88,88,88,88,88,88,88,87,87,87,88,88,88,88,87,87,87,87,88,87,88,88,88,88,88,88,88,87,85,86,88,92,96,101,105,108,108,103,91,83,81,80,79,80,78,77,75,74,74,74,74,87,88,88,87,87,87,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,86,86,87,86,86,86,86,86,87,86,87,88,88,89,89,91,91,91,91,91,91,91,91,90,91,91,90,90,89,90,89,89,89,89,89,89,89,89,89,89,89,88,88,88,88,87,88,87,87,88,88,87,87,87,87,87,87,88,87,87,87,88,87,88,87,87,87,86,87,87,87,87,87,88,88,87,88,87,86,85,86,90,94,98,102,106,106,102,92,84,81,80,78,78,78,77,75,74,73,73,73,74,87,87,88,87,87,87,87,88,88,88,88,88,88,87,87,88,87,87,87,87,87,86,87,86,86,86,87,87,87,87,87,88,89,89,90,90,91,91,91,92,91,91,91,90,90,90,90,90,89,89,89,91,90,90,90,89,89,89,89,89,88,88,88,88,88,88,88,88,87,87,88,88,88,87,88,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,86,87,86,87,87,87,89,93,98,101,104,105,81,82,83,83,81,80,80,79,78,78,77,76,76,80,84,87,88,87,87,87,87,87,88,88,88,87,87,88,88,87,87,88,87,87,87,87,87,87,87,86,87,86,87,87,88,88,88,89,89,89,91,92,91,91,92,92,91,91,91,91,91,91,90,89,90,89,89,90,90,89,90,90,89,90,90,89,88,88,88,88,87,88,87,88,87,88,88,88,88,88,88,88,88,88,88,87,88,87,87,88,88,88,88,87,87,87,87,88,87,87,87,87,87,86,86,87,88,91,94,98,102,104,105,81,83,83,83,81,81,81,80,80,79,78,77,78,82,85,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,87,87,87,86,87,86,86,86,86,86,86,86,86,87,87,87,88,90,90,90,91,91,91,90,91,91,91,91,90,89,90,89,89,90,89,89,89,89,89,89,89,88,87,88,88,87,87,87,87,87,87,87,87,88,87,88,87,88,87,87,87,87,87,88,87,87,87,87,88,87,87,87,87,88,87,87,87,88,87,87,87,86,86,86,89,92,96,100,104,86,81,82,83,83,81,79,79,78,77,76,75,74,76,81,84,86,87,87,87,88,87,87,88,88,88,87,88,87,88,87,88,88,88,87,87,87,87,87,87,87,86,86,87,86,87,87,88,88,89,89,92,91,91,92,91,92,91,91,91,91,91,90,90,90,90,90,90,90,89,89,89,89,89,89,88,88,87,88,87,88,88,88,88,87,88,88,87,88,88,88,88,87,88,88,88,87,88,88,87,87,87,87,87,87,87,87,87,87,88,87,86,85,85,86,89,93,97,102,105,106,104,94,83,81,80,79,78,78,76,76,74,74,73,73,87,87,88,88,88,88,88,88,88,88,88,88,88,87,87,88,87,87,87,87,87,87,88,87,87,86,86,87,86,87,87,88,88,88,89,90,91,92,91,91,91,91,90,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,88,87,87,87,87,87,87,87,87,87,87]}";

        myFile.println(body);
    }
    // close the file:
    myFile.close();
    Serial.println("done.");
     Serial.println("\nFiles found on the card (name, date and size in bytes): ");
  fatfs.rootDirStart();
 
  // list all files in the card with date and size
  fatfs.ls(LS_R | LS_DATE | LS_SIZE);
  } else {
    // if the file didn't open, print an error:
    Serial.println("error opening test.txt");
  }
 
//  // re-open the file for reading:
//  myFile = fatfs.open("test.txt");
//  if (myFile) {
//    Serial.println("test.txt:");
// 
//    // read from the file until there's nothing else in it:
//    while (myFile.available()) {
//      Serial.write(myFile.read());
//    }
//    // close the file:
//    myFile.close();
//  } else {
//    // if the file didn't open, print an error:
//    Serial.println("error opening test.txt");
//  }

 
}
 
void loop() {
  // nothing happens after setup
}
