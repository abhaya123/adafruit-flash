#include <WiFi.h>
//#include <AsyncTCP.h>
//#include <WiFiClient.h>
//#include "FS.h"
#include "SdFat.h"
#include "Adafruit_SPIFlash.h"
#include <WebServer.h>

//#include <ESPAsyncWebServer.h>

WebServer server(80);


 
Adafruit_FlashTransport_SPI flashTransport(SS, SPI); // Set CS and SPI interface
Adafruit_SPIFlash flash(&flashTransport);
 
// file system object from SdFat
FatFileSystem fatfs;
File32 myFile;

const char* PARAM_INPUT_1 = "input1";
String hostname = "Heartbeat";

void setup() {
  // put your setup code here, to run once:

  Serial.begin(115200);


   OnWifi();
   sd_setup();
   server.on("/download",File_Download);
//   server.on("/download",HTTP_GET,[] (AsyncWebServerRequest *request) {
//    String inputMessage;
//    String inputParam;
//    // GET input1 value on <ESP_IP>/get?input1=<inputMessage>
//    if (request->hasParam(PARAM_INPUT_1)) {
//      inputMessage = request->getParam(PARAM_INPUT_1)->value();
//      inputParam = PARAM_INPUT_1;
//    }; 
//        Serial.println(inputMessage);
//    request->send(200, "text/html", "HTTP GET request sent to your ESP on input field (" 
//                                     + inputParam + ") with value: " + inputMessage +
//                                     "<br><a href=\"/\">Return to Home Page</a>");
//
//   });
   server.begin();

}

void File_Download(){
  if(server.hasArg("name")){
    Serial.println(String(server.arg("name")));
    String fileName = String(server.arg("name"));
    File32 fileDown = fatfs.open(fileName);
    if(fileDown.available()){
      server.sendHeader("Content-Type", "text/text");
      server.sendHeader("Content-Disposition", "attachment; filename="+fileName);
      server.sendHeader("Connection", "close");
      server.streamFile(fileDown, "application/octet-stream");
      fileDown.close();
     // server.send(200,"text/html","OK");
    }
    //server.send(200,"text/html","OK");
  }
}



 void sd_setup(){
  #define W25Q128BV                                                            \
  {                                                                            \
    .total_size = (16UL << 20), /* 1 MiB */                                     \
        .start_up_time_us = 5000, .manufacturer_id = 0xef,                     \
    .memory_type = 0x40, .capacity = 0x18, .max_clock_speed_mhz = 104,         \
    .quad_enable_bit_mask = 0x02, .has_sector_protection = false,              \
    .supports_fast_read = true, .supports_qspi = true,                         \
    .supports_qspi_writes = true, .write_status_register_split = false,        \
    .single_status_byte = false, .is_fram = false,                             \
  }
 
 
static const SPIFlash_Device_t possible_devices[] = {
        W25Q128BV,
};
 
if (flash.begin(possible_devices)) {
 // if (flash.begin()) {
      Serial.println(F("Device finded and supported!"));
  } else {
      Serial.println(F("Problem to discover and configure device, check wiring also!"));
  }
  // Set 24Mhz SPI speed
  flashTransport.setClockSpeed(24000000, 24000000); // added to prevent speed problem
 
  pinMode(LED_BUILTIN, OUTPUT);
  flash.setIndicator(LED_BUILTIN, true);
 
  Serial.println("Adafruit Serial Flash read write example");
  Serial.print("JEDEC ID: "); Serial.println(flash.getJEDECID(), HEX);
  Serial.print("Flash size: "); Serial.println(flash.size());
  Serial.flush();
 
  Serial.println();
  // First call begin to mount the filesystem.  Check that it returns true
  // to make sure the filesystem was mounted.
  if (!fatfs.begin(&flash)) {
    Serial.println("Error, failed to mount newly formatted filesystem!");
    Serial.println("Was the flash chip formatted with the SdFat_format example?");
    while(1) yield();
  }
  Serial.println("Mounted filesystem!");
  Serial.println();
  writeFile();
 
 }


 void writeFile(){
  myFile = fatfs.open("test1.txt", FILE_WRITE);
 
  // if the file opened okay, write to it:
  if (myFile) {
    Serial.print("Writing to test1.txt...");
    for (int i=0;i<10;i++){
     //   myFile.print(i);
        String body = "{\"value\":60,\"battInd\":1, \"valueStr\":[87,87,87,87,87,86,86,86,87,86,86,86,87,87,87,87,88,88,89,89,90,91,91,91,91,91,90,91,91,90,91,90,90,89,90,89,90,89,89,89,88,89,89,89,89,88,87,88,87,88,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,87,87,87,85,85,86,89,92,96,101,105,107,105,94,84,81,79,78,78,78,76,75,74,73,73,73,74,88,88,88,87,87,87,88,88,88,87,87,87,87,87,86,87,86,87,87,87,87,87,87,87,86,87,87,87,87,87,87,88,88,89,89,90,91,91,91,91,91,91,91,90,90,90,90,90,89,90,90,90,90,90,89,90,89,89,89,89,89,89,88,88,87,88,89,88,88,88,88,88,87,87,87,87,88,87,87,87,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,86,89,92,97,102,105,107,104,94,85,81,81,79,78,77,77,75,74,74,74,74,75,78,83,87,87,87,88,88,88,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,88,89,90,90,90,92,92,92,92,92,92,91,91,91,91,91,90,90,90,90,91,90,90,90,90,90,89,89,89,89,89,88,87,87,88,88,88,88,87,87,86,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,87,87,87,88,86,86,88,92,96,101,105,106,106,99,88,82,80,79,79,78,77,76,74,74,73,73,73,77,87,87,87,87,87,88,88,88,87,88,88,88,88,87,87,87,87,88,88,87,87,87,87,87,87,87,87,87,87,88,89,89,90,91,91,91,91,91,92,92,92,91,91,91,90,90,90,90,89,89,90,90,90,90,89,90,90,89,89,89,89,88,89,88,88,87,88,88,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,87,87,87,87,87,87,87,87,87,91,94,99,104,106,106,101,90,83,81,82,79,78,77,76,75,73,72,73,73,75,80,84,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,86,86,87,87,87,88,89,89,90,91,91,92,91,92,91,91,90,91,91,91,90,90,89,89,89,90,90,90,90,89,90,90,89,88,88,88,88,88,88,88,87,87,88,88,88,87,87,87,88,88,88,88,87,87,87,88,87,87,88,88,88,87,88,88,88,88,88,88,88,87,87,88,86,87,89,93,97,101,105,106,104,96,85,82,81,79,79,78,77,76,75,74,73,73,74,77,88,87,87,87,87,87,88,88,87,88,88,88,88,87,87,88,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,89,90,91,91,91,91,92,91,90,91,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,89,89,87,88,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,88,88,88,88,88,87,88,88,87,87,88,88,88,88,88,87,87,89,93,98,102,104,107,105,96,86,82,81,80,79,80,78,78,76,75,75,74,74,76,88,88,87,87,88,87,87,88,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,90,91,91,91,91,92,91,91,91,92,90,90,90,90,89,89,90,90,90,89,89,89,89,88,88,88,88,87,88,88,88,87,87,88,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,87,87,87,87,87,86,87,87,87,86,87,86,87,86,85,87,89,92,96,100,103,105,103,95,83,82,82,80,80,79,79,79,77,77,77,76,83,86,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,86,86,86,86,86,87,86,87,87,88,89,89,89,90,91,91,91,92,91,91,91,90,90,90,90,89,89,89,90,90,89,89,89,89,89,89,89,89,89,88,87,88,88,88,88,88,88,87,87,88,88,88,88,88,87,88,88,88,88,88,87,87,87,87,88,87,87,87,88,87,87,88,88,88,88,88,86,86,86,90,94,98,102,105,107,104,93,84,82,80,79,79,78,77,77,75,75,74,74,75,88,88,88,88,87,88,88,87,88,88,88,88,88,87,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,89,90,91,92,91,92,92,92,92,92,92,91,90,90,91,90,90,89,90,89,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,88,88,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,85,86,89,92,97,101,105,107,105,95,84,82,80,79,78,77,77,75,74,74,73,73,74,79,87,87,87,88,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,86,87,86,87,87,87,87,88,88,89,89,90,91,92,92,92,91,91,91,91,91,91,91,90,90,90,89,89,90,90,90,89,89,89,89,89,89,88,88,88,88,87,87,88,87,87,87,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,86,87,87,87,87,87,87,90,94,99,103,106,107,102,91,83,81,82,78,78,78,76,75,73,73,73,73,75,80,84,87,87,88,87,87,88,87,88,87,87,88,88,87,87,87,87,87,87,87,87,87,86,86,87,87,86,86,87,87,88,89,89,90,90,91,92,92,91,91,91,91,90,91,91,90,90,90,90,89,90,90,90,90,90,90,90,90,89,89,89,88,88,88,88,89,88,87,88,88,88,88,88,88,88,88,88,87,87,87,88,88,88,88,87,87,87,87,88,87,88,88,88,88,88,88,88,87,85,86,88,92,96,101,105,108,108,103,91,83,81,80,79,80,78,77,75,74,74,74,74,87,88,88,87,87,87,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,86,86,87,86,86,86,86,86,87,86,87,88,88,89,89,91,91,91,91,91,91,91,91,90,91,91,90,90,89,90,89,89,89,89,89,89,89,89,89,89,89,88,88,88,88,87,88,87,87,88,88,87,87,87,87,87,87,88,87,87,87,88,87,88,87,87,87,86,87,87,87,87,87,88,88,87,88,87,86,85,86,90,94,98,102,106,106,102,92,84,81,80,78,78,78,77,75,74,73,73,73,74,87,87,88,87,87,87,87,88,88,88,88,88,88,87,87,88,87,87,87,87,87,86,87,86,86,86,87,87,87,87,87,88,89,89,90,90,91,91,91,92,91,91,91,90,90,90,90,90,89,89,89,91,90,90,90,89,89,89,89,89,88,88,88,88,88,88,88,88,87,87,88,88,88,87,88,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,86,87,86,87,87,87,89,93,98,101,104,105,81,82,83,83,81,80,80,79,78,78,77,76,76,80,84,87,88,87,87,87,87,87,88,88,88,87,87,88,88,87,87,88,87,87,87,87,87,87,87,86,87,86,87,87,88,88,88,89,89,89,91,92,91,91,92,92,91,91,91,91,91,91,90,89,90,89,89,90,90,89,90,90,89,90,90,89,88,88,88,88,87,88,87,88,87,88,88,88,88,88,88,88,88,88,88,87,88,87,87,88,88,88,88,87,87,87,87,88,87,87,87,87,87,86,86,87,88,91,94,98,102,104,105,81,83,83,83,81,81,81,80,80,79,78,77,78,82,85,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,87,87,87,86,87,86,86,86,86,86,86,86,86,87,87,87,88,90,90,90,91,91,91,90,91,91,91,91,90,89,90,89,89,90,89,89,89,89,89,89,89,88,87,88,88,87,87,87,87,87,87,87,87,88,87,88,87,88,87,87,87,87,87,88,87,87,87,87,88,87,87,87,87,88,87,87,87,88,87,87,87,86,86,86,89,92,96,100,104,86,81,82,83,83,81,79,79,78,77,76,75,74,76,81,84,86,87,87,87,88,87,87,88,88,88,87,88,87,88,87,88,88,88,87,87,87,87,87,87,87,86,86,87,86,87,87,88,88,89,89,92,91,91,92,91,92,91,91,91,91,91,90,90,90,90,90,90,90,89,89,89,89,89,89,88,88,87,88,87,88,88,88,88,87,88,88,87,88,88,88,88,87,88,88,88,87,88,88,87,87,87,87,87,87,87,87,87,87,88,87,86,85,85,86,89,93,97,102,105,106,104,94,83,81,80,79,78,78,76,76,74,74,73,73,87,87,88,88,88,88,88,88,88,88,88,88,88,87,87,88,87,87,87,87,87,87,88,87,87,86,86,87,86,87,87,88,88,88,89,90,91,92,91,91,91,91,90,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,87,86,86,86,87,87,87,87,88,88,89,89,90,91,91,91,91,91,90,91,91,90,91,90,90,89,90,89,90,89,89,89,88,89,89,89,89,88,87,88,87,88,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,87,87,87,85,85,86,89,92,96,101,105,107,105,94,84,81,79,78,78,78,76,75,74,73,73,73,74,88,88,88,87,87,87,88,88,88,87,87,87,87,87,86,87,86,87,87,87,87,87,87,87,86,87,87,87,87,87,87,88,88,89,89,90,91,91,91,91,91,91,91,90,90,90,90,90,89,90,90,90,90,90,89,90,89,89,89,89,89,89,88,88,87,88,89,88,88,88,88,88,87,87,87,87,88,87,87,87,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,86,89,92,97,102,105,107,104,94,85,81,81,79,78,77,77,75,74,74,74,74,75,78,83,87,87,87,88,88,88,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,88,89,90,90,90,92,92,92,92,92,92,91,91,91,91,91,90,90,90,90,91,90,90,90,90,90,89,89,89,89,89,88,87,87,88,88,88,88,87,87,86,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,88,87,87,87,88,86,86,88,92,96,101,105,106,106,99,88,82,80,79,79,78,77,76,74,74,73,73,73,77,87,87,87,87,87,88,88,88,87,88,88,88,88,87,87,87,87,88,88,87,87,87,87,87,87,87,87,87,87,88,89,89,90,91,91,91,91,91,92,92,92,91,91,91,90,90,90,90,89,89,90,90,90,90,89,90,90,89,89,89,89,88,89,88,88,87,88,88,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,87,87,87,87,87,87,87,87,87,91,94,99,104,106,106,101,90,83,81,82,79,78,77,76,75,73,72,73,73,75,80,84,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,86,86,86,86,86,87,87,87,88,89,89,90,91,91,92,91,92,91,91,90,91,91,91,90,90,89,89,89,90,90,90,90,89,90,90,89,88,88,88,88,88,88,88,87,87,88,88,88,87,87,87,88,88,88,88,87,87,87,88,87,87,88,88,88,87,88,88,88,88,88,88,88,87,87,88,86,87,89,93,97,101,105,106,104,96,85,82,81,79,79,78,77,76,75,74,73,73,74,77,88,87,87,87,87,87,88,88,87,88,88,88,88,87,87,88,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,89,90,91,91,91,91,92,91,90,91,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,89,89,87,88,87,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,88,88,88,88,88,87,88,88,87,87,88,88,88,88,88,87,87,89,93,98,102,104,107,105,96,86,82,81,80,79,80,78,78,76,75,75,74,74,76,88,88,87,87,88,87,87,88,87,87,87,87,88,87,87,87,87,87,87,87,87,87,87,86,86,86,86,87,87,87,88,88,89,89,90,91,91,91,91,92,91,91,91,92,90,90,90,90,89,89,90,90,90,89,89,89,89,88,88,88,88,87,88,88,88,87,87,88,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,87,87,87,87,87,86,87,87,87,86,87,86,87,86,85,87,89,92,96,100,103,105,103,95,83,82,82,80,80,79,79,79,77,77,77,76,83,86,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,87,86,87,86,86,86,86,86,87,86,87,87,88,89,89,89,90,91,91,91,92,91,91,91,90,90,90,90,89,89,89,90,90,89,89,89,89,89,89,89,89,89,88,87,88,88,88,88,88,88,87,87,88,88,88,88,88,87,88,88,88,88,88,87,87,87,87,88,87,87,87,88,87,87,88,88,88,88,88,86,86,86,90,94,98,102,105,107,104,93,84,82,80,79,79,78,77,77,75,75,74,74,75,88,88,88,88,87,88,88,87,88,88,88,88,88,87,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,89,90,91,92,91,92,92,92,92,92,92,91,90,90,91,90,90,89,90,89,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,88,88,88,88,88,87,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,85,86,89,92,97,101,105,107,105,95,84,82,80,79,78,77,77,75,74,74,73,73,74,79,87,87,87,88,88,88,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,87,87,86,87,86,87,87,87,87,88,88,89,89,90,91,92,92,92,91,91,91,91,91,91,91,90,90,90,89,89,90,90,90,89,89,89,89,89,89,88,88,88,88,87,87,88,87,87,87,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,87,87,87,86,87,87,87,87,87,87,90,94,99,103,106,107,102,91,83,81,82,78,78,78,76,75,73,73,73,73,75,80,84,87,87,88,87,87,88,87,88,87,87,88,88,87,87,87,87,87,87,87,87,87,86,86,87,87,86,86,87,87,88,89,89,90,90,91,92,92,91,91,91,91,90,91,91,90,90,90,90,89,90,90,90,90,90,90,90,90,89,89,89,88,88,88,88,89,88,87,88,88,88,88,88,88,88,88,88,87,87,87,88,88,88,88,87,87,87,87,88,87,88,88,88,88,88,88,88,87,85,86,88,92,96,101,105,108,108,103,91,83,81,80,79,80,78,77,75,74,74,74,74,87,88,88,87,87,87,87,88,88,88,87,88,87,87,87,87,87,87,87,87,87,86,86,87,86,86,86,86,86,87,86,87,88,88,89,89,91,91,91,91,91,91,91,91,90,91,91,90,90,89,90,89,89,89,89,89,89,89,89,89,89,89,88,88,88,88,87,88,87,87,88,88,87,87,87,87,87,87,88,87,87,87,88,87,88,87,87,87,86,87,87,87,87,87,88,88,87,88,87,86,85,86,90,94,98,102,106,106,102,92,84,81,80,78,78,78,77,75,74,73,73,73,74,87,87,88,87,87,87,87,88,88,88,88,88,88,87,87,88,87,87,87,87,87,86,87,86,86,86,87,87,87,87,87,88,89,89,90,90,91,91,91,92,91,91,91,90,90,90,90,90,89,89,89,91,90,90,90,89,89,89,89,89,88,88,88,88,88,88,88,88,87,87,88,88,88,87,88,87,86,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,86,87,87,87,86,87,86,87,87,87,89,93,98,101,104,105,81,82,83,83,81,80,80,79,78,78,77,76,76,80,84,87,88,87,87,87,87,87,88,88,88,87,87,88,88,87,87,88,87,87,87,87,87,87,87,86,87,86,87,87,88,88,88,89,89,89,91,92,91,91,92,92,91,91,91,91,91,91,90,89,90,89,89,90,90,89,90,90,89,90,90,89,88,88,88,88,87,88,87,88,87,88,88,88,88,88,88,88,88,88,88,87,88,87,87,88,88,88,88,87,87,87,87,88,87,87,87,87,87,86,86,87,88,91,94,98,102,104,105,81,83,83,83,81,81,81,80,80,79,78,77,78,82,85,87,87,87,87,87,87,87,88,87,87,87,87,87,87,87,86,87,87,87,86,87,86,86,86,86,86,86,86,86,87,87,87,88,90,90,90,91,91,91,90,91,91,91,91,90,89,90,89,89,90,89,89,89,89,89,89,89,88,87,88,88,87,87,87,87,87,87,87,87,88,87,88,87,88,87,87,87,87,87,88,87,87,87,87,88,87,87,87,87,88,87,87,87,88,87,87,87,86,86,86,89,92,96,100,104,86,81,82,83,83,81,79,79,78,77,76,75,74,76,81,84,86,87,87,87,88,87,87,88,88,88,87,88,87,88,87,88,88,88,87,87,87,87,87,87,87,86,86,87,86,87,87,88,88,89,89,92,91,91,92,91,92,91,91,91,91,91,90,90,90,90,90,90,90,89,89,89,89,89,89,88,88,87,88,87,88,88,88,88,87,88,88,87,88,88,88,88,87,88,88,88,87,88,88,87,87,87,87,87,87,87,87,87,87,88,87,86,85,85,86,89,93,97,102,105,106,104,94,83,81,80,79,78,78,76,76,74,74,73,73,87,87,88,88,88,88,88,88,88,88,88,88,88,87,87,88,87,87,87,87,87,87,88,87,87,86,86,87,86,87,87,88,88,88,89,90,91,92,91,91,91,91,90,91,90,90,90,90,89,89,89,90,90,90,90,90,89,89,89,89,89,88,87,87,87,87,87,87,87,87,87,87]}";

        myFile.println(body);
    }
    // close the file:
    myFile.close();
    Serial.println("done.");
 }
 }

 void sendFile(){
   myFile = fatfs.open("test1.txt");
   
 }


void OnWifi(){
    WiFi.mode(WIFI_OFF); // Prevents reconnection issue (taking too long to connect)
    delay(1000);
    WiFi.mode(WIFI_AP);
    WiFi.softAP(hostname.c_str());                // Only Station No AP, This line hides the viewing of ESP as wifi hotspot
    Serial.println("Wifi AP Mode");
    IPAddress myIP = WiFi.softAPIP(); //Get IP address
    Serial.print("AP IP address: ");
    Serial.println(myIP);
}

void loop() {

  server.handleClient();
  // put your main code here, to run repeatedly:

}
